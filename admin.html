<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Allegory of the Trade &mdash; Admin</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Lora:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="css/styles.css" />
  <link rel="stylesheet" href="css/admin.css" />
</head>
<body>

  <nav>
    <div class="nav-inner">
      <a href="index.html" class="nav-logo">Allegory of the Trade <span class="nav-badge">Admin</span></a>
      <ul class="nav-links">
        <li><a href="index.html">View Blog</a></li>
      </ul>
    </div>
  </nav>

  <div class="page">
    <div class="page-header">
      <h1>Your Posts</h1>
      <p>Write, edit, and manage your investment blog from here.</p>
    </div>

    <!-- TABS -->
    <div class="tabs">
      <button class="tab active" data-tab="write">Write</button>
      <button class="tab" data-tab="manage">Manage Posts</button>
      <button class="tab" data-tab="preview">Preview</button>
      <button class="tab" data-tab="deploy">Deploy</button>
    </div>

    <!-- WRITE TAB -->
    <div class="tab-panel active" id="tab-write">
      <div class="editor-card">
        <div class="field">
          <label for="post-title">Title</label>
          <input type="text" id="post-title" placeholder="e.g. Why I'm Bullish on Healthcare AI" />
        </div>
        <div class="field-row">
          <div class="field">
            <label for="post-tag">Tag</label>
            <select id="post-tag">
              <option value="Strategy">Strategy</option>
              <option value="Macro">Macro</option>
              <option value="Thesis">Thesis</option>
              <option value="Outlook">Outlook</option>
              <option value="Portfolio">Portfolio</option>
              <option value="Analysis">Analysis</option>
              <option value="Commentary">Commentary</option>
            </select>
          </div>
          <div class="field">
            <label for="post-excerpt">Excerpt (short summary)</label>
            <input type="text" id="post-excerpt" placeholder="A one-liner that shows on the blog feed" />
          </div>
        </div>
        <div class="field">
          <label>Body</label>
          <div class="toolbar">
            <button onclick="insertMarkdown('**', '**')" title="Bold"><b>B</b></button>
            <button onclick="insertMarkdown('*', '*')" title="Italic"><i>I</i></button>
            <button onclick="insertMarkdown('\n## ', '\n')" title="Heading">H2</button>
            <button onclick="insertMarkdown('\n### ', '\n')" title="Sub-heading">H3</button>
            <button onclick="insertMarkdown('\n> ', '\n')" title="Blockquote">"</button>
            <button onclick="insertMarkdown('\n- ', '\n')" title="List">List</button>
            <button onclick="insertMarkdown('\n---\n', '')" title="Divider">&mdash;</button>
          </div>
          <textarea id="post-body" placeholder="Write your post here. You can use simple Markdown:&#10;&#10;**bold text**&#10;*italic text*&#10;## Heading&#10;> Blockquote&#10;- List item"></textarea>
        </div>
        <div class="actions">
          <button class="btn btn-primary" onclick="publishPost()">Publish</button>
          <button class="btn btn-secondary" onclick="saveDraft()">Save Draft</button>
          <span class="status-msg" id="status-msg"></span>
        </div>
        <input type="hidden" id="editing-id" value="" />
      </div>
    </div>

    <!-- MANAGE TAB -->
    <div class="tab-panel" id="tab-manage">
      <div class="post-count" id="post-count"></div>
      <ul class="posts-list" id="posts-list"></ul>
    </div>

    <!-- PREVIEW TAB -->
    <div class="tab-panel" id="tab-preview">
      <div id="preview-content"></div>
    </div>

    <!-- DEPLOY TAB -->
    <div class="tab-panel" id="tab-deploy">
      <div class="deploy-card">
        <h3>Export Posts for Deployment</h3>
        <p>Download your published posts as a <code>posts.json</code> file. Replace the existing one in your site folder, then push to GitHub to update your live site.</p>
        <ol class="deploy-steps">
          <li><span class="step-num">1</span><span>Click <strong>Export posts.json</strong> below to download your latest posts</span></li>
          <li><span class="step-num">2</span><span>Replace the <code>posts.json</code> file in your site folder with the downloaded one</span></li>
          <li><span class="step-num">3</span><span>Commit and push to GitHub &mdash; your site updates automatically</span></li>
        </ol>
        <div style="margin-top:1.25rem; display:flex; gap:0.75rem; flex-wrap:wrap;">
          <button class="btn btn-primary" onclick="exportPostsJson()">Export posts.json</button>
          <button class="btn btn-secondary" onclick="exportAllBackup()">Export Full Backup</button>
        </div>
      </div>

      <div class="deploy-card">
        <h3>Import Posts</h3>
        <p>Restore from a backup or import posts from another device. Paste your JSON below.</p>
        <div class="import-area">
          <textarea id="import-json" placeholder='Paste your posts JSON here...'></textarea>
          <button class="btn btn-secondary" onclick="importPosts()">Import</button>
          <span class="status-msg" id="import-status"></span>
        </div>
      </div>

      <div class="deploy-card">
        <h3>Hosting Quick Start</h3>
        <p>Your site is hosted on GitHub Pages with a custom domain via Cloudflare.</p>
        <ol class="deploy-steps">
          <li><span class="step-num">1</span><span>Edit files in the <code>reedcasey/investment-blog</code> repo on GitHub</span></li>
          <li><span class="step-num">2</span><span>Commit changes to main branch</span></li>
          <li><span class="step-num">3</span><span>GitHub Pages auto-deploys to <code>allegoryofthetrade.com</code></span></li>
        </ol>
      </div>
    </div>
  </div>

  <!-- Admin uses the shared markdown parser from blog.js -->
  <script src="js/blog.js"></script>
  <script>
    // ==========================================
    // STORAGE
    // ==========================================
    // STORAGE_KEY is already defined in blog.js

    function getPosts() {
      try {
        return JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
      } catch { return []; }
    }

    function savePosts(posts) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(posts));
    }

    // ==========================================
    // TABS
    // ==========================================
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById('tab-' + tab.dataset.tab).classList.add('active');

        if (tab.dataset.tab === 'manage') renderPostsList();
        if (tab.dataset.tab === 'preview') renderPreview();
      });
    });

    // ==========================================
    // MARKDOWN TOOLBAR
    // ==========================================
    function insertMarkdown(before, after) {
      const ta = document.getElementById('post-body');
      const start = ta.selectionStart;
      const end = ta.selectionEnd;
      const selected = ta.value.substring(start, end);
      const replacement = before + (selected || 'text') + after;
      ta.setRangeText(replacement, start, end, 'select');
      ta.focus();
    }

    // ==========================================
    // PUBLISH / SAVE
    // ==========================================
    function publishPost() {
      const title = document.getElementById('post-title').value.trim();
      const tag = document.getElementById('post-tag').value;
      const excerpt = document.getElementById('post-excerpt').value.trim();
      const body = document.getElementById('post-body').value.trim();
      const editingId = document.getElementById('editing-id').value;

      if (!title) { showStatus('Please add a title', true); return; }
      if (!body) { showStatus('Please write some content', true); return; }

      const posts = getPosts();
      const now = new Date().toISOString();

      if (editingId) {
        const idx = posts.findIndex(p => p.id === editingId);
        if (idx !== -1) {
          posts[idx] = { ...posts[idx], title, tag, excerpt, body, status: 'published', updatedAt: now };
        }
        document.getElementById('editing-id').value = '';
      } else {
        posts.unshift({
          id: 'post_' + Date.now(),
          title,
          tag,
          excerpt: excerpt || body.substring(0, 140) + '...',
          body,
          status: 'published',
          createdAt: now,
          updatedAt: now,
        });
      }

      savePosts(posts);
      clearEditor();
      showStatus('Published!');
    }

    function saveDraft() {
      const title = document.getElementById('post-title').value.trim();
      const tag = document.getElementById('post-tag').value;
      const excerpt = document.getElementById('post-excerpt').value.trim();
      const body = document.getElementById('post-body').value.trim();
      const editingId = document.getElementById('editing-id').value;

      if (!title && !body) { showStatus('Nothing to save', true); return; }

      const posts = getPosts();
      const now = new Date().toISOString();

      if (editingId) {
        const idx = posts.findIndex(p => p.id === editingId);
        if (idx !== -1) {
          posts[idx] = { ...posts[idx], title, tag, excerpt, body, updatedAt: now };
        }
      } else {
        posts.unshift({
          id: 'post_' + Date.now(),
          title: title || 'Untitled Draft',
          tag,
          excerpt,
          body,
          status: 'draft',
          createdAt: now,
          updatedAt: now,
        });
      }

      savePosts(posts);
      showStatus('Draft saved');
    }

    function clearEditor() {
      document.getElementById('post-title').value = '';
      document.getElementById('post-tag').selectedIndex = 0;
      document.getElementById('post-excerpt').value = '';
      document.getElementById('post-body').value = '';
      document.getElementById('editing-id').value = '';
    }

    function showStatus(msg, isError) {
      const el = document.getElementById('status-msg');
      el.textContent = msg;
      el.style.color = isError ? 'var(--red)' : 'var(--green)';
      el.classList.add('show');
      setTimeout(() => el.classList.remove('show'), 2500);
    }

    // ==========================================
    // MANAGE POSTS LIST
    // ==========================================
    function renderPostsList() {
      const posts = getPosts();
      const countEl = document.getElementById('post-count');
      const listEl = document.getElementById('posts-list');

      const published = posts.filter(p => p.status === 'published').length;
      const drafts = posts.filter(p => p.status === 'draft').length;
      countEl.textContent = `${published} published, ${drafts} draft${drafts !== 1 ? 's' : ''}`;

      if (posts.length === 0) {
        listEl.innerHTML = '<div class="empty-state">No posts yet. Go to the Write tab to create your first post.</div>';
        return;
      }

      listEl.innerHTML = posts.map(p => {
        const date = new Date(p.createdAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        const statusBadge = p.status === 'draft'
          ? '<span style="color:var(--text-light);font-style:italic"> &mdash; Draft</span>'
          : '';
        return `
          <li class="post-row">
            <div class="post-row-left">
              <div class="post-row-title">${p.title}${statusBadge}</div>
              <div class="post-row-meta">${p.tag} Â· ${date}</div>
            </div>
            <div class="post-row-actions">
              <button onclick="editPost('${p.id}')">Edit</button>
              ${p.status === 'draft' ? `<button onclick="publishById('${p.id}')">Publish</button>` : `<button onclick="unpublishPost('${p.id}')">Unpublish</button>`}
              <button class="delete-btn" onclick="deletePost('${p.id}')">Delete</button>
            </div>
          </li>`;
      }).join('');
    }

    function editPost(id) {
      const posts = getPosts();
      const post = posts.find(p => p.id === id);
      if (!post) return;

      document.getElementById('post-title').value = post.title;
      document.getElementById('post-tag').value = post.tag;
      document.getElementById('post-excerpt').value = post.excerpt;
      document.getElementById('post-body').value = post.body;
      document.getElementById('editing-id').value = post.id;

      // Switch to write tab
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
      document.querySelector('[data-tab="write"]').classList.add('active');
      document.getElementById('tab-write').classList.add('active');

      showStatus('Editing: ' + post.title);
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function publishById(id) {
      const posts = getPosts();
      const idx = posts.findIndex(p => p.id === id);
      if (idx !== -1) {
        posts[idx].status = 'published';
        posts[idx].updatedAt = new Date().toISOString();
        savePosts(posts);
        renderPostsList();
      }
    }

    function unpublishPost(id) {
      const posts = getPosts();
      const idx = posts.findIndex(p => p.id === id);
      if (idx !== -1) {
        posts[idx].status = 'draft';
        posts[idx].updatedAt = new Date().toISOString();
        savePosts(posts);
        renderPostsList();
      }
    }

    function deletePost(id) {
      if (!confirm('Delete this post? This cannot be undone.')) return;
      const posts = getPosts().filter(p => p.id !== id);
      savePosts(posts);
      renderPostsList();
    }

    // ==========================================
    // PREVIEW (uses markdownToHtml from blog.js)
    // ==========================================
    function renderPreview() {
      const title = document.getElementById('post-title').value.trim();
      const tag = document.getElementById('post-tag').value;
      const body = document.getElementById('post-body').value.trim();
      const container = document.getElementById('preview-content');

      if (!title && !body) {
        container.innerHTML = '<div class="preview-empty">Start writing in the Write tab to see a live preview here.</div>';
        return;
      }

      const today = new Date().toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
      container.innerHTML = `
        <div class="preview-card">
          <span class="preview-tag">${tag}</span>
          <h2>${title || 'Untitled'}</h2>
          <div class="preview-date">${today}</div>
          <div class="preview-body">${markdownToHtml(body)}</div>
        </div>`;
    }

    // ==========================================
    // DEPLOY -- EXPORT / IMPORT
    // ==========================================
    function exportPostsJson() {
      const posts = getPosts().filter(p => p.status === 'published');
      const json = JSON.stringify(posts, null, 2);
      downloadFile('posts.json', json, 'application/json');
    }

    function exportAllBackup() {
      const posts = getPosts();
      const json = JSON.stringify(posts, null, 2);
      const date = new Date().toISOString().slice(0, 10);
      downloadFile(`blog-backup-${date}.json`, json, 'application/json');
    }

    function downloadFile(filename, content, type) {
      const blob = new Blob([content], { type });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function importPosts() {
      const raw = document.getElementById('import-json').value.trim();
      const statusEl = document.getElementById('import-status');
      if (!raw) {
        statusEl.textContent = 'Paste JSON first';
        statusEl.style.color = 'var(--red)';
        statusEl.classList.add('show');
        setTimeout(() => statusEl.classList.remove('show'), 2500);
        return;
      }
      try {
        const imported = JSON.parse(raw);
        if (!Array.isArray(imported)) throw new Error('Not an array');
        savePosts(imported);
        statusEl.textContent = `Imported ${imported.length} post(s)!`;
        statusEl.style.color = 'var(--green)';
        statusEl.classList.add('show');
        document.getElementById('import-json').value = '';
        setTimeout(() => statusEl.classList.remove('show'), 3000);
      } catch (e) {
        statusEl.textContent = 'Invalid JSON \u2014 check the format';
        statusEl.style.color = 'var(--red)';
        statusEl.classList.add('show');
        setTimeout(() => statusEl.classList.remove('show'), 3000);
      }
    }

    // ==========================================
    // INIT -- seed from posts.json if localStorage is empty
    // ==========================================
    (async function init() {
      const existing = getPosts();
      if (existing.length === 0) {
        try {
          const res = await fetch('posts.json');
          if (res.ok) {
            const data = await res.json();
            if (data.length > 0) {
              savePosts(data);
            }
          }
        } catch {}
      }
    })();
  </script>

</body>
</html>
